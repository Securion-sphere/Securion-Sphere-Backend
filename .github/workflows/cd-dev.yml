name: Deploy dev to Self-Hosted

env:
    APP_PORT: ${{ secrets.APP_PORT }}
    DB_HOST: ${{ secrets.DB_HOST }}
    DB_USER: ${{ secrets.DB_USER }}
    DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    DB_NAME: ${{ secrets.DB_NAME }}
    DB_PORT: ${{ secrets.DB_PORT }}
    MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
    MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
    CLIENT_ID: ${{ secrets.CLIENT_ID }}
    CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
    CALLBACK_URL: ${{ secrets.CALLBACK_URL }}
    JWT_SECRET: ${{ secrets.JWT_SECRET }}
    JWT_EXPIRE_IN: ${{ secrets.JWT_EXPIRE_IN }}
    REFRESH_JWT_SECRET: ${{ secrets.REFRESH_JWT_SECRET }}
    REFRESH_JWT_EXPIRE_IN: ${{ secrets.REFRESH_JWT_EXPIRE_IN }}
    FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
    TZ: ${{ secrets.TZ }}

on:
    workflow_dispatch:
    workflow_run:
        workflows: ['CI for Development']
        branches: ['dev']
        types:
            - completed

jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
        name: Deploy to dev
        runs-on: self-hosted
        steps:
            - name: Copy repository
              uses: actions/checkout@v4
    
            - name: Build the docker-compose stack
              run: docker compose up -d --build
        
            - name: Clear all docker unused cache
              run: docker system prune -af
